
# Canvasベースアウトライナー実装仕様まとめ

## 1. データ構造

アプリケーションのすべての状態を単一の`state`オブジェクトで管理します。これにより、状態の変更、保存、Undo/Redoが容易になります。

```javascript
const state = {
    // すべての行をフラットな配列で管理
    lines: [
        { id: 'uuid-1', text: '最初の行', indent: 0, collapsed: false },
        { id: 'uuid-2', text: '子要素', indent: 1, collapsed: false },
        // ...
    ],
    // カーソルの現在位置
    cursor: {
        lineIndex: 0, // lines配列内のインデックス
        charIndex: 0  // text内の文字位置
    },
    // テキストの選択範囲 (なければnull)
    selection: {
        start: { lineIndex: 0, charIndex: 0 },
        end: { lineIndex: 0, charIndex: 5 }
    },
    // Undo/Redoのための状態履歴
    history: {
        undoStack: [], // 過去のstateのスナップショット
        redoStack: []
    },
    // 表示に関する設定と状態
    view: {
        scrollTop: 0,           // 垂直スクロール位置
        font: '16px sans-serif',// 使用フォント
        lineHeight: 24,         // 1行の高さ
        indentWidth: 24         // インデント1レベル分の幅
    }
};
```

## 2. Canvasレンダリングの基本設計

キー入力やマウス操作によって`state`が更新されるたびに、Canvas全体を再描画する方式を採用します。

1. **状態更新**: ユーザー操作により`state`オブジェクトの内容を変更します。
2. **描画要求**: `requestAnimationFrame`を呼び出し、次のフレームで描画関数を実行するようにスケジュールします。
3. **描画処理 (`render`関数)**:
    a. `context.clearRect()`でCanvasを完全にクリアします。
    b. 表示すべき行（折りたたまれていない行）をループ処理します。
    c. 各行について、インデント、折りたたみアイコン、テキスト（記法を解釈したもの）、カーソル、選択範囲を描画します。

### ユーティリティ関数（必須）

- `getParent(lineIndex)`: 指定した行の親となる行のインデックスを返します。配列を遡り、インデントレベルが小さい最初の行を探します。
- `isVisible(lineIndex)`: 指定した行が表示対象かどうかを判定します。`getParent`を再帰的に呼び出し、祖先のいずれかが`collapsed: true`になっていないかを確認します。

## 3. 機能別実装詳細

### 3.1. インデントと折りたたみアイコンの描画

- **インデント**: テキストの描画開始X座標を `line.indent * state.view.indentWidth` という計算で決定します。
- **折りたたみアイコン**:
    1. 次の行のインデントが現在の行より大きい場合、その行は「子を持つ」と判断します。
    2. 子を持つ行の行頭に、`line.collapsed`プロパティの値に応じてアイコンを描画します (`true`なら`▶`、`false`なら`▼`)。

### 3.2. テキスト、カーソル、選択範囲の描画

- **テキスト**: `context.fillText(text, x, y)`で描画します。
- **カーソル**: `context.measureText()`を使い、カーソル位置までのテキスト幅を測定してX座標を算出後、`context.fillRect()`で細い長方形として描画します。
- **選択範囲**: 選択範囲の開始・終了座標を計算し、`context.fillStyle`に半透明色を設定した上で`context.fillRect()`で背景色を描画します。

### 3.3. 記法（リッチテキスト）の描画

描画時にテキストを解析し、スタイル付きのパーツに分割してから描画します。

1. **パース**: 1つの文字列を、正規表現などを用いてオブジェクトの配列に変換します。（例: `'Link: https://~'` → `[{ text: 'Link: ' }, { text: 'https://~', isLink: true }]`）
2. **描画**: 配列をループし、各パーツのスタイル（色など）を`context`に設定しながら、`fillText()`で順番に描画していきます。

### 3.4. イベントハンドリングと状態更新

`canvas`要素に`keydown`や`mousedown`などのイベントリスナーを設定し、ユーザー入力を受け取ります。イベントに応じて`state`オブジェクトを更新し、再描画をトリガーします。

- **キー入力**: `state.lines`の`text`プロパティや`state.cursor`を更新します。
- **マウス操作**: クリック座標からカーソル位置を計算し`state.cursor`を更新します。ドラッグ操作で`state.selection`を更新します。

---

## 4. 折りたたみ

- **トリガー**: `Ctrl+Enter`
- **動作**:
    1. 現在カーソルがある行の`collapsed`プロパティの真偽値を反転させます。
    2. 再描画時、`isVisible`関数が各行の表示/非表示を決定します。親が`collapsed: true`である子は描画されなくなります。
    3. アイコンも`▶` / `▼`に切り替わります。

## 5. 行の入れ替え

- **トリガー**: `Ctrl+Up` / `Ctrl+Down`
- **動作**:
    1. 移動対象の行と、それに続くインデントが深いすべての行（子孫）を一つのブロックとして特定します。
    2. `state.lines`配列内で、このブロックを`Array.prototype.splice()`などを用いてごっそりと移動させます。
    3. 再描画により、行が入れ替わって表示されます。

## 6. 記法

描画時にテキストを解釈し、見た目を変更します。

| 記法 | 説明 |
| :--- | :--- |
| `>` (行頭) | 引用として解釈し、テキストをグレイアウトするなどのスタイルで描画します。 |
| `https://...` | URLを自動で検出し、青字などのリンクスタイルで描画します。クリックで新しいタブを開きます。 |
| `[text]` | 相対リンクとして解釈します。<br>- **カーソル行**: `[text]` のように角括弧付きのプレーンテキストで表示します。<br>- **非カーソル行**: `text` のように角括弧なしのリンクスタイルで表示します。 |

## 7. 入力

- **トリガー**: `[`キーの入力。
- **動作**:
    1. `keydown`イベントを捕捉し、デフォルトの文字入力をキャンセルします (`event.preventDefault()`)。
    2. カーソル位置に`[]`という2文字を挿入します。
    3. カーソルを自動的に`[`と`]`の間に移動させます。
- その他：日本語のIME入力に対応。

## 8. ショートカット

### 8.1. 一般的なエディタ機能

| キー | 動作 |
| :--- | :--- |
| `Enter` | 現在のインデントレベルを維持したまま改行（新しい行オブジェクトを配列に挿入）。 |
| `←/↑/↓/→` | カーソルを移動。 |
| `Home` / `End` | カーソルを行頭/行末へ移動。 |
| `Ctrl+Z` | Undo（操作前の`state`を`history.undoStack`から復元）。 |
| `Ctrl+Shift+Z` | Redo（Undoした`state`を`history.redoStack`から復元）。 |
| `Ctrl+C/X/V` | テキストのコピー/切り取り/貼り付け。 |

#### 選択範囲があるときの動作

| キー | 動作 |
| :--- | :--- |
| `Ctrl+C` / `Ctrl+X` | 選択範囲のテキストをコピー/切り取り。 |
| `Backspace` / `Delete` | 選択範囲を削除。 |
| (文字入力) | 選択範囲を削除し、入力した文字を挿入。 |

### 8.2. アウトライナー用のショートカット

| キー | 条件 | 動作 |
| :--- | :--- | :--- |
| `Ctrl` + `↑/↓` | - | 行全体を子孫ごと一段上下に移動（行の入れ替え）。 |
| `Ctrl` + `→` / `Tab` | - | インデントレベルを1つ上げる（インデントを深くする）。 |
| `Ctrl` + `←` / `Shift+Tab`| - | インデントレベルを1つ下げる（インデントを浅くする）。 |
| `Ctrl+Enter` | - | 現在行の配下を折りたたみ/展開。 |
| `Shift+Enter` | - | インデントレベルが0の新しい行を挿入。 |
| `Space` | 行頭で | インデントレベルを1つ上げる。 |
| `Backspace` | 行頭で | インデントレベルを1つ下げる。 |

#### 選択範囲があるときの動作（複数行）

| キー | 動作 |
| :--- | :--- |
| `Tab` / `Ctrl` + `→` | 選択されているすべての行のインデントレベルを1つ上げる。 |
| `Shift+Tab` / `Ctrl` + `←` | 選択されているすべての行のインデントレベルを1つ下げる。 |`←` | 選択されているすべての行のインデントレベルを1つ下げる。 |
